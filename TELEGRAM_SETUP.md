# Настройка интеграции с Telegram

## Шаг 1: Получение токена бота

1. Откройте Telegram и найдите бота [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен (например: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

## Шаг 2: Настройка токена в .env

Добавьте токен в файл `backend/.env`:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_бота
```

## Шаг 3: Настройка Webhook (для production)

Для production используйте webhook. Telegram будет отправлять сообщения на ваш сервер.

### Вариант A: Если у вас есть публичный URL

1. Убедитесь, что ваш сервер доступен из интернета
2. Настройте webhook через API:

```bash
curl -X POST "https://api.telegram.org/bot<ВАШ_ТОКЕН>/setWebhook?url=https://ваш-домен.com/api/telegram/webhook"
```

Или используйте endpoint в вашем приложении:

```bash
POST http://localhost:5000/api/telegram/setup-webhook
{
  "webhookUrl": "https://ваш-домен.com/api/telegram/webhook"
}
```

### Вариант B: Для локальной разработки (ngrok)

1. Установите [ngrok](https://ngrok.com/)
2. Запустите ngrok:
   ```bash
   ngrok http 5000
   ```
3. Скопируйте HTTPS URL (например: `https://abc123.ngrok.io`)
4. Настройте webhook:
   ```bash
   curl -X POST "https://api.telegram.org/bot<ВАШ_ТОКЕН>/setWebhook?url=https://abc123.ngrok.io/api/telegram/webhook"
   ```

## Шаг 4: Проверка работы

1. Перезапустите backend сервер
2. Отправьте сообщение вашему боту в Telegram
3. Сообщение должно появиться в интерфейсе оператора как новый диалог

## Как это работает

1. **Пользователь отправляет сообщение в Telegram** → Telegram отправляет его на ваш webhook
2. **Webhook получает сообщение** → `/api/telegram/webhook` обрабатывает его
3. **Создается диалог** → В базе данных создается новый диалог с типом "telegram"
4. **Сообщение сохраняется** → Сообщение сохраняется в базу данных
5. **Уведомление операторам** → Все операторы в сети получают уведомление о новом диалоге
6. **Оператор отвечает** → Когда оператор отправляет сообщение в интерфейсе, оно автоматически отправляется в Telegram

## API Endpoints

### Webhook (для Telegram)
```
POST /api/telegram/webhook
```
Telegram автоматически отправляет сюда все входящие сообщения.

### Тестовое сообщение
```
POST /api/telegram/test
{
  "chatId": "123456789",
  "message": "Тестовое сообщение"
}
```

### Настройка webhook
```
POST /api/telegram/setup-webhook
{
  "webhookUrl": "https://ваш-домен.com/api/telegram/webhook"
}
```

## Отправка сообщений оператором

Когда оператор отправляет сообщение в интерфейсе для диалога из Telegram:
1. Сообщение сохраняется в базу данных
2. Автоматически отправляется в Telegram пользователю
3. Пользователь видит ответ в Telegram

## Решение проблем

### Сообщения не приходят

1. Проверьте, что токен правильный в `.env`
2. Проверьте, что webhook настроен:
   ```bash
   curl "https://api.telegram.org/bot<ВАШ_ТОКЕН>/getWebhookInfo"
   ```
3. Убедитесь, что backend запущен и доступен
4. Проверьте логи backend на наличие ошибок

### Сообщения не отправляются в Telegram

1. Проверьте, что токен правильный
2. Убедитесь, что `client_id` в диалоге соответствует `chat_id` в Telegram
3. Проверьте логи backend

### Webhook не работает локально

Используйте ngrok для создания туннеля к вашему локальному серверу (см. Вариант B выше).

## Пример использования

1. Пользователь пишет боту в Telegram: "Здравствуйте, у меня вопрос"
2. В интерфейсе оператора появляется новый диалог из канала "Telegram"
3. Оператор открывает диалог и видит сообщение
4. Оператор отвечает: "Здравствуйте! Чем могу помочь?"
5. Пользователь получает ответ в Telegram
6. Диалог продолжается в интерфейсе оператора и в Telegram одновременно

## Безопасность

⚠️ **Важно:**
- Никогда не публикуйте токен бота в открытом доступе
- Используйте HTTPS для webhook в production
- Рассмотрите возможность добавления проверки подписи от Telegram

## Дополнительные возможности

В будущем можно добавить:
- Поддержку файлов и изображений
- Поддержку кнопок и inline-клавиатуры
- Поддержку голосовых сообщений
- Поддержку стикеров и GIF
